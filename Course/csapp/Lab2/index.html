<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>CSAPP深入理解计算机系统 Lab2(bomb Lab) 详解 | LCJD BLOG# 页面title</title>
  <meta name="description" content="本文以记录个人学习CSAPP的过程，使用blog的方式记录能更专注的思考，不至于走马观花式的做实验。同时我关注的不仅是实验本身还有实验中使用工具的学习。   实验说明 本实验通过逆向的方式模拟拆炸弹的过程，炸弹共有6道锁，我们需要逐一破解每一道锁，最终拆除炸弹。我们可以通过执行.&#x2F;bomb开始输入密码，也可以把密码输入到任意文件中作为参数传递给.&#x2F;bomb，例如.&#x2F;bomb passwords.">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP深入理解计算机系统 Lab2(bomb Lab) 详解">
<meta property="og:url" content="https://lcjd99.github.io/Course/csapp/Lab2/index.html">
<meta property="og:site_name" content="凌晨九点空间">
<meta property="og:description" content="本文以记录个人学习CSAPP的过程，使用blog的方式记录能更专注的思考，不至于走马观花式的做实验。同时我关注的不仅是实验本身还有实验中使用工具的学习。   实验说明 本实验通过逆向的方式模拟拆炸弹的过程，炸弹共有6道锁，我们需要逐一破解每一道锁，最终拆除炸弹。我们可以通过执行.&#x2F;bomb开始输入密码，也可以把密码输入到任意文件中作为参数传递给.&#x2F;bomb，例如.&#x2F;bomb passwords.">
<meta property="og:locale">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-9b3695afc8bac4451a797bbe9360cc4c.png">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-a8b040d6cbb6ba8407f94345439cb3d4.png">
<meta property="article:published_time" content="2023-10-15T14:51:47.000Z">
<meta property="article:modified_time" content="2024-04-12T15:34:10.862Z">
<meta property="article:author" content="凌晨九点">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic4.zhimg.com/80/v2-9b3695afc8bac4451a797bbe9360cc4c.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://lcjd99.github.io/Course/csapp/Lab2/index.html">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    <link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet">
  
  
  
  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="凌晨九点空间" type="application/atom+xml">
</head>


<body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/LCJD99" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">凌晨九点</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">CS Student</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/LCJD99" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CS61C/">CS61C</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CSAPP/">CSAPP</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%80%83%E7%A0%94/">考研</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computer-Organization/" rel="tag">Computer Organization</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Network/" rel="tag">Linux Network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utils/" rel="tag">utils</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/C/" style="font-size: 14px;">C</a> <a href="/tags/Computer-Organization/" style="font-size: 13px;">Computer Organization</a> <a href="/tags/Linux-Network/" style="font-size: 13px;">Linux Network</a> <a href="/tags/utils/" style="font-size: 13px;">utils</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E8%80%83%E7%A0%94/">考研</a>
              </p>
              <p class="item-title">
                <a href="/Postgraduate/CS/Organization/Lecture2/" class="title">【考研】计组 （二）： 数据的表示和运算</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-12T14:51:47.000Z" itemprop="datePublished">2024-04-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Linux/">Linux</a>
              </p>
              <p class="item-title">
                <a href="/Linux/concurrent-in-linux/" class="title">Linux中对网络并发处理的技术</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-10T09:15:47.000Z" itemprop="datePublished">2024-04-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/git/">git</a>
              </p>
              <p class="item-title">
                <a href="/utils/git-1/" class="title">git 入门教程（一）：基本用法</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-09T14:50:47.000Z" itemprop="datePublished">2024-04-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/others/">others</a>
              </p>
              <p class="item-title">
                <a href="/others/c-format-output/" class="title">C语言格式化输出问题</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-04T14:51:47.000Z" itemprop="datePublished">2024-04-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/CS61C/">CS61C</a>
              </p>
              <p class="item-title">
                <a href="/Course/cs61c/Lab2/" class="title">【CS61C】Lab2 实验解析</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-04T14:51:47.000Z" itemprop="datePublished">2024-04-04</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-Course/csapp/Lab2" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      CSAPP深入理解计算机系统 Lab2(bomb Lab) 详解
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/Course/csapp/Lab2/" class="article-date">
	  <time datetime="2023-10-15T14:51:47.000Z" itemprop="datePublished">2023-10-15</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/CSAPP/">CSAPP</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/C/" rel="tag">C</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/Course/csapp/Lab2/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 4.7k(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 20(minutes)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <blockquote>
<p>本文以记录个人学习CSAPP的过程，使用blog的方式记录能更专注的思考，不至于走马观花式的做实验。同时我关注的不仅是实验本身还有实验中使用工具的学习。</p>
</blockquote>
<h2 id="实验说明"><a class="markdownIt-Anchor" href="#实验说明"></a> 实验说明</h2>
<p>本实验通过逆向的方式模拟拆炸弹的过程，炸弹共有6道锁，我们需要逐一破解每一道锁，最终拆除炸弹。我们可以通过执行<code>./bomb</code>开始输入密码，也可以把密码输入到任意文件中作为参数传递给<code>./bomb</code>，例如<code>./bomb passwords.txt</code></p>
<p>在动手实验之前需要仔细阅读<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomblab.pdf">实验说明</a>, 其中重点阅读<strong>Hints</strong>的章节，这里提供一些提示</p>
<ol>
<li><strong>gdb</strong>, gdb是一个命令行调试器，我们可以用gdb查看程序的汇编并且轻易的查看内存。这里有一个CMU的简明<a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~gilpin/tutorial/">gdb使用教程</a>，</li>
<li><strong>objdump -t</strong> ，这个命令可以打印出炸弹的符号表，符号表会打印出所有函数名和函数地址。我们可以对程序的整体有一个直观的认识，同时快速定位到函数的位置。</li>
<li><strong>objdump -d</strong> ，这个命令会直接打印出整个程序的汇编指令</li>
<li><strong>prints</strong> 这个命令会打印出可打印的字符串。</li>
</ol>
<p>还有一些工具能够提供官方文档：</p>
<ol>
<li><code>apropos</code>，能够检索并列出本地相关关键词的文档</li>
<li><code>man</code>，能够提供相应的官方文档，使用<code>man ascii</code>能方便获取到各个字符的ascii码</li>
</ol>
<blockquote>
<p>声明：本文后续转换的代码并被严格的C代码，而是描述思路的伪代码，并没有严格区分指针和值等的表述关系</p>
</blockquote>
<h2 id="实验具体流程"><a class="markdownIt-Anchor" href="#实验具体流程"></a> 实验具体流程</h2>
<h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3>
<p>实验提供一个c版本的框架可以让我们快速了解程序的框架，我们看到整个程序中的六个函数是<code>phase_&#123;1..6&#125;</code>，如果输入字符正确则会拆除炸弹。</p>
<h4 id="1-逆向产生汇编代码并保存"><a class="markdownIt-Anchor" href="#1-逆向产生汇编代码并保存"></a> 1. 逆向产生汇编代码并保存</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d &gt; source.S</span><br></pre></td></tr></table></figure>
<p>对于这个项目，我们需要关注其<code>.text</code>字段，为了方便我们可以删除其他字段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -t bomb &gt; table.txt</span><br></pre></td></tr></table></figure>
<p>这里对其做一些解释。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000000000400ac0	l	d		.init  0000000000000000	.init</span><br><span class="line">0000000000000000	l	df	*ABS*  0000000000000000	bomb.c</span><br></pre></td></tr></table></figure>
<p>根据其manual中的解释</p>
<blockquote>
<p>Here the first number is the symbol’s value (sometimes referred to as its address).  The next field is actually a set of characters and spaces indicating the flag bits that are set on the symbol.  These characters are described below.  Next is the section with which the symbol is associated or <em>ABS</em> if the section is absolute (ie not connected with any section), or <em>UND</em> if the section is referenced in the file being dumped, but not defined there. After the section name comes another field, a number, which for common symbols is the alignment and for other symbol is the size.Finally the symbol’s name is displayed.</p>
</blockquote>
<ol>
<li>第一列是标识符的地址或者值。</li>
<li>第二列是一个标记位，具体标记规则见其manual文档，这里给出几个常见的标记 :<code>l</code>代表本地，<code>g</code>代表全局，<code>f</code>代表文件，<code>F</code>代表函数，<code>O</code>代表对象。</li>
<li>第三列是标识符对应的段，其中<code>*ABS*</code>代表绝对的位置，<code>UND</code>代表没有定义在当前程序中。</li>
<li>地四列是对齐方式或变量大小</li>
<li>最后是标记符名</li>
</ol>
<h4 id="2使用strings获取"><a class="markdownIt-Anchor" href="#2使用strings获取"></a> 2.使用strings获取</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings bomb &gt; strings.txt</span><br></pre></td></tr></table></figure>
<p>将数据存储在strings.txt中以便后续使用。</p>
<h4 id="3整体逻辑分析"><a class="markdownIt-Anchor" href="#3整体逻辑分析"></a> 3.整体逻辑分析</h4>
<p>定位到其<code>main</code>的函数的字段，分析其执行逻辑，观察到如下代码段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">400e19:	e8 84 05 00 00       	call   4013a2 &lt;initialize_bomb&gt;</span><br><span class="line">400e1e:	bf 38 23 40 00       	mov    $0x402338,%edi</span><br><span class="line">400e23:	e8 e8 fc ff ff       	call   400b10 &lt;puts@plt&gt;</span><br><span class="line">400e28:	bf 78 23 40 00       	mov    $0x402378,%edi</span><br><span class="line">400e2d:	e8 de fc ff ff       	call   400b10 &lt;puts@plt&gt;</span><br><span class="line">400e32:	e8 67 06 00 00       	call   40149e &lt;read_line&gt;</span><br></pre></td></tr></table></figure>
<p>在这里是炸弹的初始化阶段，<code>edi</code>寄存器用于传递参数作为存储数据的位置，也就是说这里是输出程序的第一个炸弹提示语的地方，我们可以通过<code>gdb</code>进行验证。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb bomb</span><br></pre></td></tr></table></figure>
<p>进入gdb界面后我们通过<code>b main</code>将断点设置在<code>main</code>开始处，并通过<code>r</code>，执行到断点处。执行如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x402338</span><br><span class="line">0x402338:   <span class="string">&quot;Welcome to my fiendish little bomb. You have 6 phases with&quot;</span></span><br></pre></td></tr></table></figure>
<p>验证和推理一致，我同样可以在Strings.txt中找到这个字符串，这样我们就知道几个工具的用途，接下来就需要灵活应用来拆除炸弹了。</p>
<h3 id="phase_1"><a class="markdownIt-Anchor" href="#phase_1"></a> phase_1</h3>
<p>第一个密码的破解我们首先定位到main函数中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">400e32:	e8 67 06 00 00       	call   40149e &lt;read_line&gt;</span><br><span class="line">400e37:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">400e3a:	e8 a1 00 00 00       	call   400ee0 &lt;phase_1&gt;</span><br></pre></td></tr></table></figure>
<p>以下部分是对程序的深入探索，单纯解题可以跳到分割线后。</p>
<hr />
<p>我们知道这里将这里将函数<code>read_line</code>的返回值地址作为函数<code>phase_1</code>的参数传递</p>
<p>先看到函数<code>read_line</code>，根据函数名我们大致推测这是简单读入一行字符，但是不知道是否还有其他操作。根据其中调用的函数<code>skip</code>理解其含义（理解的过程中可以对照table.txt中的变量确定大小和位置,借用gdb确定其值），将<code>skip</code>写出伪代码大概如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">skip()&#123;</span><br><span class="line">  <span class="keyword">do</span>&#123;</span><br><span class="line">  	<span class="comment">//这里有一段很令人迷惑的汇编会在最后彩蛋部分解释</span></span><br><span class="line">		...</span><br><span class="line">    rdi = <span class="number">0x603780</span>;</span><br><span class="line">    rdx = (<span class="built_in">stdin</span>);</span><br><span class="line">    esi = <span class="number">80</span>;</span><br><span class="line">    <span class="comment">// 如果读到函数会返回地址，如果未读到返回空</span></span><br><span class="line">    rax= fgets(addr= rdi, size= esi, stream = rdx); </span><br><span class="line">    rbx = rax;</span><br><span class="line">    <span class="keyword">if</span>(rax == <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">//没有读到行</span></span><br><span class="line">    rdi = rax;</span><br><span class="line">    eax = blank_line(rdi); <span class="comment">//判断是否为空行</span></span><br><span class="line">  &#125;<span class="keyword">while</span>(eax != <span class="number">0</span>)</span><br><span class="line">  rax = rbx;</span><br><span class="line">  <span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>skip</code>会自动跳过空行读取到第一个有数据的行，或者错误的行。</p>
<p><strong>read_line()有大量代码用于检测各种输入问题，同时隐藏细节，在彩蛋部分会解释，这里只需要知道这是一个读入一行字符串的函数即可</strong></p>
<hr />
<p>接下来正式进入<code>phase_1</code>的代码</p>
<p>我们发现在调用<code>strings_not_equal</code>时，他仅仅是将<code>0x402400</code>传递给第二个参数<code>esi</code>，而第一个参数是传入函数的参数可以写出如下伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">phase_1(rdi)&#123;</span><br><span class="line">	esi = <span class="number">0x402400</span>;</span><br><span class="line">	eax = strings_not_equals(rdi, esi);</span><br><span class="line">	<span class="keyword">if</span>(eax != <span class="number">0</span>)&#123;</span><br><span class="line">		explode_bomb(); <span class="comment">//爆炸</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到<code>strings_not_equals</code>的代码可以转化为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">strings_not_equals(rdi, rsi)&#123;</span><br><span class="line">	<span class="comment">//第一个字符串</span></span><br><span class="line">	rbx = rdi;</span><br><span class="line">	<span class="comment">//第二个字符串</span></span><br><span class="line">	rbp = rsi;</span><br><span class="line">	eax = string_length(rdi);</span><br><span class="line">	<span class="comment">//r12d 存长度</span></span><br><span class="line">	r12d = eax;</span><br><span class="line">	rdi = rbp;</span><br><span class="line">	eax = string_length(rdi);</span><br><span class="line">  <span class="keyword">if</span>(eax != r12d) retrun eax = edx = <span class="number">1</span>;</span><br><span class="line">	eax = *(rbx);</span><br><span class="line">	<span class="keyword">for</span>(al != <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(al != *(rbp)) retrun eax = edx = <span class="number">1</span>;</span><br><span class="line">		rbx++;</span><br><span class="line">		rbp++;</span><br><span class="line">		eax = *(rbx);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> eax = edx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是正常的判断是否相等的代码。</p>
<p>所有只需要通过gdb找到<code>0x402400</code>位置的字符串即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x402400</span><br><span class="line">0x402400:       <span class="string">&quot;Border relations with Canada have never been better.&quot;</span></span><br></pre></td></tr></table></figure>
<p>这个字符串即结果</p>
<h3 id="phase_2"><a class="markdownIt-Anchor" href="#phase_2"></a> phase_2</h3>
<p>调用函数前的过程详见<em>phase_1</em>的解析，我们直接关注到调用的函数内部。</p>
<p>函数中调用<code>read_six_number</code>函数的解析如下</p>
<p>这个函数其实让我们看到机器在参数多于寄存器能表达的数量是所做的工作，利用栈来保存结果指针的位置。该函数所做的工作就是将<code>rsi</code>传递过来的参数（也就是需要存储的指针）分别存在6个变量中以便<code>sscanf</code>调用时能够存储到正确的位置。</p>
<p>首先我们看到sscanf的声明如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sscanf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *<span class="keyword">restrict</span> str, <span class="type">const</span> <span class="type">char</span> *<span class="keyword">restrict</span> format, ...)</span>;</span><br></pre></td></tr></table></figure>
<p>而这里传递的第二个参数对应于<code>format</code>,我们通过<code>gdb</code>查看对应的寄存器<code>$esi</code>位置<code>0x4025c3</code>可知</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4025c3</span><br><span class="line">0x4025c3:       <span class="string">&quot;%d %d %d %d %d %d&quot;</span></span><br></pre></td></tr></table></figure>
<p>所需要解析的是6个32位整数，对应每个变量大小为4B，也和代码中以4B为基准将指针记入寄存器相同。</p>
<p>我们可以看到6个整数指针的对应关系如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">str			$rdi</span><br><span class="line">format	$rsi</span><br><span class="line">arg0		$rdx</span><br><span class="line">arg1		$rcx</span><br><span class="line">arg2		$r8</span><br><span class="line">arg3		$r9</span><br><span class="line">arg4		($rsp)</span><br><span class="line">arg5		($rsp + 8)</span><br></pre></td></tr></table></figure>
<p>这样就能把6个整数从字符串中解析到指针<code>$rsi</code>所指向的地址中，下面看回<code>phase_2</code>可以表示为如下伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">phase_2(rdi)&#123;</span><br><span class="line">	rsi = rsp;</span><br><span class="line">	read_six_numbers(rdi, rsi); <span class="comment">//将6个数据从rdi字符串中读入rsp位置中</span></span><br><span class="line">	<span class="keyword">if</span>(rsp[<span class="number">0</span>] != <span class="number">1</span>) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;<span class="number">6</span>; ++i)&#123;</span><br><span class="line">		<span class="keyword">if</span>(rsp[i] != rsp[i<span class="number">-1</span>] + rsp[i<span class="number">-1</span>])&#123;</span><br><span class="line">			explode_bomb();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有可以知道第二个密码应该是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 4 8 16 32</span><br></pre></td></tr></table></figure>
<h3 id="phase_3"><a class="markdownIt-Anchor" href="#phase_3"></a> phase_3</h3>
<p>开始读取两个整数的操作和<code>phase_2</code>完全相同，后面的部分核心的语句为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">400f75: ff 24 c5 70 24 40 00  jmp    *0x402470(,%rax,8)</span><br></pre></td></tr></table></figure>
<p>我们在<code>gdb</code>里打印对应内存信息如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/x *0x402470</span><br><span class="line">0x400f7c &lt;phase_3+57&gt;:  0xb8</span><br></pre></td></tr></table></figure>
<p>说明这里对应的就是<code>&lt;phase_3+57&gt; + 8 * $rax</code>，而观察发现下面的代码正好每两行占用内存空间为8B，所有这就是一个switch语句。伪代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">phase_3(rdi)&#123;</span><br><span class="line">	rdx = rsp + <span class="number">8</span>;</span><br><span class="line">	rcx = rsp + <span class="number">12</span>;</span><br><span class="line">	rax = <span class="built_in">sscanf</span>(rdi, rsi, rdx, rcx);</span><br><span class="line">	<span class="keyword">if</span>(rax &gt; <span class="number">1</span> &amp;&amp; (rsp+<span class="number">8</span>) &gt; <span class="number">7</span>)&#123;</span><br><span class="line">		<span class="keyword">switch</span>((rax))&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			eax = <span class="number">0xcf</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		..  <span class="comment">//后续省略</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( (rsp + <span class="number">12</span>) != eax)&#123;</span><br><span class="line">			explode_bomb();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有本题的答案有八组，任意选择其中的一组即可，我选择 <code>0 207</code></p>
<h3 id="phase_4"><a class="markdownIt-Anchor" href="#phase_4"></a> phase_4</h3>
<p>本题前面读入两个整数的过程和<code>phase_3</code>相同，为便于分析逻辑可以直接替换变量名，容易转换为如下形式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">phase_4(str)&#123;</span><br><span class="line">	<span class="built_in">sscanf</span>(str, <span class="string">&quot;%d %d&quot;</span>, a, b);</span><br><span class="line">	<span class="keyword">if</span>(a &gt; <span class="number">15</span>)&#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">	ans = func4(a, <span class="number">0</span>, <span class="number">15</span>);</span><br><span class="line">	<span class="keyword">if</span>(ans != <span class="number">0</span> || b != <span class="number">0</span>)&#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面重点放在<code>func4</code>函数中，我们看到这个函数需要三个参数，分析函数后可以将其转化为以下递归函数，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func4(rdi, rsi, rdx)&#123;</span><br><span class="line">	eax = (rdx) - (rsi);</span><br><span class="line">	ecx = (<span class="type">unsigned</span>)(eax) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	ecx = rax + rsi + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(ecx &lt;= edi)&#123;</span><br><span class="line">		rdx = rcx - <span class="number">1</span>;</span><br><span class="line">		rax = func4(rdi, rsi, rdx);</span><br><span class="line">		rax = rax * <span class="number">2</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(ecx == edi)&#123;</span><br><span class="line">		rax = <span class="number">0</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    esi = rcx + <span class="number">1</span>;</span><br><span class="line">    rax = func4(rdi, rsi, rdx);</span><br><span class="line">    rax = rax * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在根据调用是的限制条件知道可以转化为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func4(x, y, z)&#123;</span><br><span class="line">	tmp = z - y + (z &lt; y ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	tmp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">	tmp += y;</span><br><span class="line">	<span class="comment">//tmp 实际上就是 (y + z) / 2;</span></span><br><span class="line">	<span class="keyword">if</span>(tmp &gt; x)&#123;</span><br><span class="line">		ans = func4(x, y, tmp - <span class="number">1</span>);</span><br><span class="line">		ans = ans * <span class="number">2</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tmp == x)&#123;</span><br><span class="line">		ans = <span class="number">0</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    ans = func4(x, tmp + <span class="number">1</span>, z);</span><br><span class="line">    ans = ans * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出其实就是一个二分查找的算法，而让ans为0的方法是，始终保证<code>x</code>，在中值的左边，直到找到中间值为<code>x</code>时。</p>
<p>始终选择左边的中间值如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">( 0 + 15 ）/ 2 = 7</span><br><span class="line">( 0 + 7  ) / 2 = 3</span><br><span class="line">( 0 + 3  ) / 2 = 1</span><br><span class="line">( 0 + 1  ) / 2 = 0</span><br></pre></td></tr></table></figure>
<p>所有最终第一个数可以是<code>7,3,1,0</code>，第二个数为<code>0</code></p>
<h3 id="phase_5"><a class="markdownIt-Anchor" href="#phase_5"></a> phase_5</h3>
<p>本题有一点真正破解的的感觉了，通过汇编代码会发现，整个过程分为三个阶段，我将逐一解释，为方便起见，我会给字符串以<code>a,b,c</code>命名。</p>
<h4 id="1-确保读入的字符串a长度为6并进入一个循环"><a class="markdownIt-Anchor" href="#1-确保读入的字符串a长度为6并进入一个循环"></a> 1. 确保读入的字符串a长度为6，并进入一个循环</h4>
<p>这里的代码没有什么特别的，但是有一个与解题无关的小细节小细节，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">40106a:	64 48 8b 04 25 28 00 	mov    %fs:0x28,%rax</span><br><span class="line">401071:	00 00 </span><br><span class="line">401073:	48 89 44 24 18       	mov    %rax,0x18(%rsp)</span><br><span class="line">...</span><br><span class="line">4010de:	64 48 33 04 25 28 00 	xor    %fs:0x28,%rax</span><br><span class="line">4010e5:	00 00 </span><br><span class="line">4010e7:	74 05                	je     4010ee &lt;phase_5+0x8c&gt;</span><br><span class="line">4010e9:	e8 42 fa ff ff       	call   400b30 &lt;__stack_chk_fail@plt&gt;</span><br></pre></td></tr></table></figure>
<p>这里实际上是在栈中偏移为<code>0x18</code>的地方放置一个用于验证的验证码，确保在函数返回是能找到正确的返回地址，防止出现通过读入字符串而破坏栈，从而植入非法地址的问题。</p>
<h4 id="2-通过a获取新字符串"><a class="markdownIt-Anchor" href="#2-通过a获取新字符串"></a> 2. 通过a获取新字符串</h4>
<p>核心代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">40108b:	0f b6 0c 03          	movzbl (%rbx,%rax,1),%ecx</span><br><span class="line">40108f:	88 0c 24             	mov    %cl,(%rsp)</span><br><span class="line">401092:	48 8b 14 24          	mov    (%rsp),%rdx</span><br><span class="line">401096:	83 e2 0f             	and    $0xf,%edx</span><br><span class="line">401099:	0f b6 92 b0 24 40 00 	movzbl 0x4024b0(%rdx),%edx</span><br><span class="line">4010a0:	88 54 04 10          	mov    %dl,0x10(%rsp,%rax,1)</span><br></pre></td></tr></table></figure>
<p>我们可以看到，其中<code>rax</code>相当于字符串的偏移量，取出的字符串也只需要其低位的字，又以该字为偏移量到<code>0x4024b0</code>中取出一个字，并放在栈中的指定位置。</p>
<p>我们通过gdb打印出<code>0x4024b0</code>处的字符串（可以看作是一个对应的哈希表）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4024b0</span><br><span class="line">0x4024b0 &lt;array.3449&gt;:  <span class="string">&quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们指需要前16个字符，因为取出低位最多访问16个字符</p>
<p>抽象出的代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> * str = <span class="string">&quot;xxxxxx&quot;</span> <span class="comment">//输入的字符串</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * hash = <span class="string">&quot;maduiersnfotvbyl&quot;</span>; <span class="comment">//0x4024b0</span></span><br><span class="line"><span class="type">char</span> ans[<span class="number">7</span>]; <span class="comment">//0x10(%rsp)</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)&#123;</span><br><span class="line">  ans[i] = hash[str[i] &amp; <span class="number">0xf</span>];</span><br><span class="line">&#125;</span><br><span class="line">ans[<span class="number">6</span>] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">//4010ae: movb   $0x0,0x16(%rsp)</span></span><br></pre></td></tr></table></figure>
<h4 id="3-比较生成的字符串和秘密表"><a class="markdownIt-Anchor" href="#3-比较生成的字符串和秘密表"></a> 3. 比较生成的字符串和秘密表</h4>
<p>最终的密码放在<code>0x40245e</code>的位置处，通过<code>gdb</code>可知为<code>flyers</code>，因此只要能让我们输入的字符串作为键产生相应的值即可。具体如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x27;f&#x27; &lt;=&gt; hash[0x9]</span><br><span class="line">&#x27;l&#x27; &lt;=&gt; hash[0xd]</span><br><span class="line">&#x27;y&#x27; &lt;=&gt; hash[0xc]</span><br><span class="line">&#x27;e&#x27; &lt;=&gt; hash[0x5]</span><br><span class="line">&#x27;r&#x27; &lt;=&gt; hash[0x6]</span><br><span class="line">&#x27;s&#x27; &lt;=&gt; hash[0x7]</span><br></pre></td></tr></table></figure>
<p>通过键入<code>man ascii</code>找到任意对应的值字符即可，我选择的是<code>IONEFG</code></p>
<h3 id="phase_6"><a class="markdownIt-Anchor" href="#phase_6"></a> phase_6</h3>
<p>在最开始的部分和<code>phase_2</code>一样通过字符串将6个整数读入栈中，接下来的代码将分为以下几个部分</p>
<h4 id="1-双重循环"><a class="markdownIt-Anchor" href="#1-双重循环"></a> 1. 双重循环</h4>
<p>首先看代码从<code> 0x40110e</code>到<code>0x401151</code>的部分。</p>
<p>这里的<code>r13</code>代表外层循环的位置，<code>r12d</code>代表外层指针索引，可以抽象为以代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> arr[<span class="number">6</span>]; <span class="comment">//6个数</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)&#123;</span><br><span class="line">  <span class="keyword">if</span>(arr[i] &lt; <span class="number">1</span> || arr[i] &gt; <span class="number">6</span>)&#123;</span><br><span class="line">    explode_bomb();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(j = i; j &lt; <span class="number">6</span>; ++j)&#123;</span><br><span class="line">    <span class="keyword">if</span>(arr[i] == arr[j])&#123;</span><br><span class="line">      explode_bomb();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明这6个数互不相同其都在[1,6]之间，也就是1到6的排列。<s>(难怪官方要限制测试数量，这里写个脚本暴力测试只需要最多5! = 120次就可以测出答案)</s></p>
<h4 id="2-数据修改"><a class="markdownIt-Anchor" href="#2-数据修改"></a> 2. 数据修改</h4>
<p>代码从<code> 0x401153</code>到<code>0x40116d</code>的部分，将数据都用7减去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">6</span>; ++i)&#123;</span><br><span class="line">  arr[i] = <span class="number">7</span> - arr[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3链表查询"><a class="markdownIt-Anchor" href="#3链表查询"></a> 3.链表查询</h4>
<p>代码从<code> 0x40116f</code>到<code>0x4011a9</code>的部分。</p>
<p>我们看到<code>rdx</code>存储的实际上是<code>0x6032d0</code>，而其变换方式是<code>mov    0x8(%rdx),%rdx</code>，也就是说将代码当前位置偏移8B位置下的数据作存入<code>rdx</code>中，实际上就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">	<span class="type">long</span> data; <span class="comment">//数据为8B</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">node</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一个结构的链表的遍历方式。</p>
<p>而在代码中又通过<code>arr[i]</code>作为其控制遍历的位置，并将地址存入栈中，可以将这部分代码表示为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>*  <span class="title">keys</span>[6];</span> <span class="comment">//0x20(%rsp）</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>* <span class="title">first</span> =</span> <span class="number">0x6032d0</span>; <span class="comment">//头结点位置</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">6</span>; ++i)&#123;</span><br><span class="line">	<span class="type">int</span> times = arr[i] - <span class="number">1</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">node</span> * <span class="title">tmp</span> =</span> first;</span><br><span class="line">	<span class="keyword">while</span>(times--)&#123;</span><br><span class="line">		tmp = tmp -&gt; next;</span><br><span class="line">	&#125;</span><br><span class="line">	keys[i] = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4将结点值重新赋值"><a class="markdownIt-Anchor" href="#4将结点值重新赋值"></a> 4.将结点值重新赋值</h4>
<p>代码从<code> 0x4011ab</code>到<code>0x4011d0</code>的部分。</p>
<p>在这里<code>rcx</code>可以理解为新链表的当前指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>* <span class="title">current</span> =</span> keys[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="type">long</span> rdx = keys[i]-&gt;data;</span><br><span class="line">	current-&gt;next-&gt;data = rdx;</span><br><span class="line">	i++;</span><br><span class="line">	<span class="keyword">if</span>(i &gt;= <span class="number">6</span>) <span class="keyword">break</span>;</span><br><span class="line">	current = key[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一步相当于将链表的值按照<code>keys</code>中的顺序重新赋值</p>
<h4 id="5判断结点是否满足关系"><a class="markdownIt-Anchor" href="#5判断结点是否满足关系"></a> 5.判断结点是否满足关系</h4>
<p>代码从<code> 0x4011da</code>到<code>0x4011f5</code>的部分。</p>
<p>可以将<code>rbx</code>看作当前指针<code>current</code>，这里有个坑在于虽然数据存储的8B，但是在比较时却只使用其中4位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">5</span>;</span><br><span class="line">current = keys[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">while</span>(i--)&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">node</span>* <span class="title">next</span> =</span> current-&gt;next;  <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">if</span>((<span class="type">int</span>)curret-&gt;data &lt; (<span class="type">int</span>)next-&gt;data)&#123; <span class="comment">//</span></span><br><span class="line">  	explode_bomb();</span><br><span class="line">  &#125;</span><br><span class="line">  current = next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出需要数据在链表中顺序排列</p>
<h4 id="6通过分析结果反推密码"><a class="markdownIt-Anchor" href="#6通过分析结果反推密码"></a> 6.通过分析结果反推密码</h4>
<p>我们通过gdb以此查找处链表中的数据如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node1: 0x014c</span><br><span class="line">node2: 0x00a8</span><br><span class="line">node3: 0x039c</span><br><span class="line">node4: 0x02b3</span><br><span class="line">node5: 0x01dd</span><br><span class="line">node6: 0x01bb</span><br></pre></td></tr></table></figure>
<p>所以需要保证其数据为排列为<code>3 4 5 6 1 2</code>，又因为在第2步用7将数据去补数，所以转换后为<code>4 3 2 1 6 5</code></p>
<h3 id="结束了彩蛋"><a class="markdownIt-Anchor" href="#结束了彩蛋"></a> 结束了？（彩蛋）</h3>
<p>将所有结果按行写入文件<code>key.txt</code>后，执行<code>./bomb key.txt</code>，会得到以下结果</p>
<p><img src="https://pic4.zhimg.com/80/v2-9b3695afc8bac4451a797bbe9360cc4c.png" alt="执行结果" /></p>
<p>但是在看汇编代码时可以看到其实本实验还有一个隐藏部分，在<code>phase_defused</code>中会尝试从有个这样<code>sscanf(0x603870, &quot;%d %d %s&quot;, rdx, rcx, r8)</code>的函数调用，输入串中读入一个<code>&quot;%d %d %s&quot;</code>的数据，并比较其中的<code>%s</code>是否为<code>&quot;DrEvil&quot;</code>，如果符合条件将进入隐藏函数<code>secret_phase</code></p>
<p>我们看到这个函数 <code>secret_phase</code>中只需判断函数<code>fun7($6030f0, input) == 2</code>即可，函数<code>fun7()</code>表示如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//x($edi) y($esi)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun7</span><span class="params">(<span class="type">void</span>* x, <span class="type">void</span>* y)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0xfffffffff</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(*(<span class="type">int</span> *)x &gt; *(<span class="type">int</span> *)y)&#123;<span class="comment">//part1</span></span><br><span class="line">		<span class="keyword">return</span> fun7(x+<span class="number">0x8</span>, y) * <span class="number">2</span>; </span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(*(<span class="type">int</span> *)x == *(<span class="type">int</span> *)y)&#123;<span class="comment">//part2</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(*(<span class="type">int</span> *)x &lt; *(<span class="type">int</span> *)y)&#123;<span class="comment">//part3</span></span><br><span class="line">		<span class="keyword">return</span> fun7(x+<span class="number">0x10</span>, y)*<span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>为保证达到目的，画出递归栈可知道，需要保证递归栈中的顺序为<code>part2 part3 part1</code> （从栈顶向下看）即可。使用gdb查看内存情况如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/16x 0x6030f0    //需要知道 n1 + 8 存储的地址</span><br><span class="line">0x6030f0 &lt;n1&gt;:  0x24    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x6030f8 &lt;n1+8&gt;:        0x10    0x31    0x60    0x00    0x00    0x00    0x00   0x00</span><br><span class="line"></span><br><span class="line">(gdb) x/24x 0x603110		//需要知道 n21 + 16 存储的地址</span><br><span class="line">0x603110 &lt;n21&gt;: 0x08    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x603118 &lt;n21+8&gt;:       0x90    0x31    0x60    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x603120 &lt;n21+16&gt;:      0x50    0x31    0x60    0x00    0x00    0x00    0x00    0x00</span><br><span class="line"></span><br><span class="line">(gdb) x/8x 0x603150			//需要知道 n32存储的值</span><br><span class="line">0x603150 &lt;n32&gt;: 0x16    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br></pre></td></tr></table></figure>
<p>由此知结果应该表示为<code>22</code>(即0x16)</p>
<p>想要触发并解题，应在任意一道做对后一行输入<code>x x DrEvil</code> (前面两个数字目前看来为任意值)。现在问题转化成如何将这个字符串放在<code>0x6030f0</code>的内存中。</p>
<p>这让我想到第一次读到<code>skip</code>开始那一段没有看懂的代码（可以回看到<code>phase_1部分</code>）。现在抱着目的性的看就豁然开朗。这里实际上是通过记录输入字符串的数量作为偏移量的，将每个读入的字符串都存在内存中的，相当于一个字符串堆，计算过程如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x603870 - 0x603780 = 240  //偏移总量</span><br><span class="line">240 &gt;&gt; 4 = 240 / 2^4 = 15  //对应shl操作</span><br><span class="line">15 / 5 = 3 //对应lea</span><br></pre></td></tr></table></figure>
<p>说明在第4个字符串时应该写入这个串，那么读入这个串后如何读入正常的第4个串，其实对于sscanf它根据给定格式匹配，所以第四个字符<code>1 0</code> 后加入能<code>DrEvil</code>即可。不得不说这样的设计还是很精妙的。</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>最后贴图测试结果</p>
<p><img src="https://pic4.zhimg.com/80/v2-a8b040d6cbb6ba8407f94345439cb3d4.png" alt="测试结果" /></p>
<p>对于这个实验，我是以直接阅读逆向的汇编代码为主。实际上以做题为目的，将GDB作为主要调试工具更快，更高效。我认为lab2的特点在于循序渐进，它的前后铺垫做的很好，整体做下来对汇编的理解会提升不少。欢迎大家留言讨论，共同学习。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://lcjd99.github.io/Course/csapp/Lab2/" title="CSAPP深入理解计算机系统 Lab2(bomb Lab) 详解" target="_blank" rel="external">https://lcjd99.github.io/Course/csapp/Lab2/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/LCJD99" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/LCJD99" target="_blank"><span class="text-dark">凌晨九点</span><small class="ml-1x">CS Student</small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/Course/csapp/Lab3/" title="CSAPP深入理解计算机系统 Lab3(attack Lab) 详解"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/Course/csapp/Lab1/" title="CSAPP深入理解计算机系统 Lab1(Data Lab) 详解"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/LCJD99" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>